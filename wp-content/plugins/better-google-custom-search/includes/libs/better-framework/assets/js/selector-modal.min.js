/***
 *  BetterFramework is BetterStudio framework for themes and plugins.
 *
 *  ______      _   _             ______                                           _
 *  | ___ \    | | | |            |  ___|                                         | |
 *  | |_/ / ___| |_| |_ ___ _ __  | |_ _ __ __ _ _ __ ___   _____      _____  _ __| | __
 *  | ___ \/ _ \ __| __/ _ \ '__| |  _| '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /
 *  | |_/ /  __/ |_| ||  __/ |    | | | | | (_| | | | | | |  __/\ V  V / (_) | |  |   <
 *  \____/ \___|\__|\__\___|_|    \_| |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\
 *
 *  Copyright Â© 2017 Better Studio
 *
 *
 *  Our portfolio is here: http://themeforest.net/user/Better-Studio/portfolio
 *
 *  \--> BetterStudio, 2017 <--/
 */
!function(t){"use strict";var e=function(e,s){this.options=t.extend(!0,{itemBeforeHtml:'<li class="bssm-item" data-item-type="{{type}}" data-item-cat="{{cat}}" data-item-id="{{id}}">',itemInnerHtml:"",itemAfterHtml:"</li>",modalHtml:!1,id:"modal-"+Math.ceil(1e3*Math.random()),bsModal:s||{},content:{},items:{},itemsGroupSize:6,fuse:{keys:["name"],tokenize:!0,matchAllTokens:!0,threshold:.3},searchDelay:300,overlayClickCloseModal:!0,searchAutoFocus:!0,selectedItemId:0,modalClass:"",categories:{},types:{},inactivateTypes:[],inactivateCats:[],events:{show_item:function(t){t.style.display="inline-block"},hide_item:function(t){t.style.display="none"}}},e),this.options.modalHtml||(this.options.modalHtml='<div class="bs-modal-default bs-selector-modal '+this.options.modalClass+'" {{#inline_style}} style="{{inline_style}}" {{/inline_style}}>\n{{#close_button}}\n<a href="#" class="bs-close-modal">\n    <i class="fa fa-times" aria-hidden="true"></i>\n</a>\n{{/close_button}}\n<div class="bs-modal-header-wrapper bs-modal-clearfix">\n    <h2 class="bs-modal-header">\n        {{#icon}}\n        <i class="fa {{icon}}"></i>\n        {{/icon}}\n\n        {{header}}\n    </h2>\n</div>\n\n<div class="bs-modal-body">\n    <!--{{{bs_body}}}-->\n\n    <input type="hidden" name="item" class="bssm-input">\n\n    <div class="bssm-content">\n        <ul class="bssm-list">\n            {{#items}}\n                '+this.options.itemBeforeHtml+this.options.itemInnerHtml+this.options.itemAfterHtml+'        \n            {{/items}}\n        </ul>\n    </div>\n    <div class="bssm-sidebar">\n        <div class="bssm-search">\n            <input type="text" class="bssm-search-input" value="" placeholder="{{search}}" autofocus>\n            <i class="fa fa-search"></i>\n        </div>\n\n        <div class="bssm-filter">\n            <div class="bssm-categories">\n                <h4 class="title"><span>{{filter_cat_title}}</span></h4>\n\n                <ul class="bssm-filter-items">\n                    {{#filter_cats}}\n                    <li>{{{ch}}} <span class="name" data-id="{{key}}">{{value}} <span class="length">({{count}})</span></span>\n                    </li>\n                    {{/filter_cats}}\n                </ul>\n            </div>\n\n\n            <div class="bssm-types">\n                <h4 class="title"><span>{{filter_type_title}}</span></h4>\n\n                <ul class="bssm-filter-items">\n                    {{#filter_types}}\n                    <li>{{{ch}}} <span class="name" data-id="{{key}}">{{value}} {{#count}}<span class="length">({{count}})</span>{{/count}}</span>\n                    </li>\n                    {{/filter_types}}\n                </ul>\n            </div>\n        </div>\n\n        <div class="bssm-sidebar-footer">\n            {{{bs_buttons}}}\n        </div>\n    </div>\n</div>'),this.bsModal=!1,this.$allItems=!1,this.$itemsCache={},this._scrollIntoView=[],this._visibleItems=[],this.selectedItem=!1,this.initialized=!1,this.fuse=new Fuse(this.options.items,this.options.fuse),this.init()};e.prototype={init:function(){var e=this;e.initialized=!0,t.bs_modal_template(this.options.id,this.options.modalHtml);var s={modalId:this.options.id,buttons:this.options.buttons,destroyHtml:!1,modalClass:this.options.modalClass,show:!1,styles:{container:"width: 1060px;max-width:100%"},template:this.options.id,content:e._getModalContent(),events:{before_append_html:function(){},after_append_html:function(){e.bsModal=this,e.updateItemsList(),e._bindEvents(),e._clearSearchResults(),e._updateSidebarCheckboxStatus(),e.handleEvent("after_append_html","")},modal_closed:function(){e._clearSearchResults(),e._updateSidebarCheckboxStatus("dont-refresh-items"),e._showHide(e.$allItems,!0),e.handleEvent("modal_closed",""),e.initialized=!1},modal_loaded:function(){e.options.searchAutoFocus&&t("input.bssm-search-input",this.$modal).focus(),e.handleEvent("modal_loaded","")},modal_show:function(){e.handleEvent("modal_show",""),e.initialized&&e.scrollIntoView(0,e.options.itemsGroupSize)}}};t.bs_modal(t.extend(!0,s,e.options.bsModal))},show:function(){this.bsModal.show()},updateItemsList:function(){this.$allItems=t(".bssm-item",this.bsModal.$modal)},_bindEvents:function(){function e(t){a._visibleItems=t}function s(){function e(e){var s=[];return t(".bssm-"+e+" .bf-checkbox-multi-state[data-current-state='active']",o).each(function(){var e=t(this).parent();s.push(e.find(".name").data("id"))}),s}var s={itemType:e("types"),itemCat:e("categories")};return a._filterItems(function(){var e,i,n,o=a.$(this).data();for(var l in s)if(i=!0,n=!0,e=s[l],i="object"==typeof e?-1===t.inArray(o[l],e):e!=o[l]){n=!1;break}return n})}function i(){function t(){var t=l.width(),e=l.find(".bssm-item").outerWidth(!0);return Math.max(1,Math.floor(t/e))}function e(){var e=a.options.itemsGroupSize/t();return Math.ceil(l.scrollTop()/(s*e))}var s=c.outerHeight(!0),i=e();if(i){var n=i*a.options.itemsGroupSize;a.scrollIntoView(n,n+a.options.itemsGroupSize)}}function n(s){if(-1===t.inArray(s.which,[32,27])){clearTimeout(r);var i=t.trim(this.value),n=t(this).parent(),o=n.find("i.fa");n[i?"addClass":"removeClass"]("active"),i?o.addClass("fa-times-circle").removeClass("fa-search"):o.removeClass("fa-times-circle").addClass("fa-search"),r=setTimeout(function(){if(i){var t=[];a.fuse.search(i).forEach(function(e){t.push(e.id)});for(var s,n=[],o=0;o<a.$allItems.length;o++)s=-1!==t.indexOf(a.get_attr(a.$allItems[o],"itemId")),s&&n.push(a.$allItems[o]);a._showHide(a.$allItems,!1),a._showHide(n,!0),e(n)}else a.$allItems.show(),e(a.$allItems)},a.options.searchDelay)}}var a=this,o=this.bsModal.$modal;e(a.$allItems);var l=t(".bssm-list",o),c=l.find(".bssm-item");a._cacheItems(c),a.eventExists("item_click")&&c.on("click",function(){a.handleEvent("item_click",this)}),c.on("click",function(){var t=a.$(this);a.markAsSelected(t),a.handleEvent("item_select",this,t.data("item-id"))});var r;t(".bssm-search",o).each(function(){var e=t(this);t(".bssm-search-input",e).on("keyup",n),e.on("click",".fa-times-circle",function(){var s=t(".bssm-search-input",e);s.val(""),s.trigger("keyup")})}),t(".bssm-sidebar .bf-checkbox-multi-state",o).on("bf-checkbox-change",function(i,n,l){if("dont-refresh-items"!==l){t(".bssm-search-input",o).val("");var c=s();a._showHide(a.$allItems,!1),a._showHide(c,!0),e(c)}}),a.eventExists("scrollIntoView")&&l.on("scroll",function(){i()}),a.options.overlayClickCloseModal&&a.bsModal.find(".bs-modal-overlay").on("click",function(){a.bsModal.close_modal()})},scrollIntoView:function(t,e){for(var s,i=this,n=i._visibleItems.slice(t,e),a=[],o=0;o<n.length;o++)s=i.get_attr(n[o],"itemId"),-1===i._scrollIntoView.indexOf(s)&&(i._scrollIntoView.push(s),a.push(n[o]));a.length&&i.handleEvent("scrollIntoView",a,t,e)},getSelectedItem:function(){return this.selectedItem},setSelectedItem:function(t,e){this.selectedItem=[t,e]},markAsSelected:function(t){this.$allItems.removeClass("bssm-selected"),t.addClass("bssm-selected"),this.setSelectedItem(t,t.data("item-id"))},_getModalContent:function(){function t(t,e){for(var s,i=0;i<t.length;i++)s=t[i].key,e[s]&&(t[i].count=e[s]);return t}function e(t){for(var e,s={},i=0;o>i;i++)e=n.items[i][t],s[e]?s[e]++:s[e]=1;return s}var s,i=this,n=i.options.content,a=i.options;n.items=i.options.items;var o=i._length(i.options.items);return s=i._prepareObjectForMustache(a.categories),n.filter_cats=t(s,e("cat")),s=i._prepareObjectForMustache(a.types),n.filter_types=t(s,e("type")),n.ch='<div class="bf-checkbox-multi-state" data-current-state="active">\n    <input type="hidden"\n           class="bf-checkbox-status"\n           value="active">\n\n    <span data-state="none"></span>\n    <span data-state="active" class="bf-checkbox-active" style="display: inline-block;">\n        <i class="fa fa-check" aria-hidden="true"></i>\n    </span>\n</div>',this.handleEvent("modal_content",n)},_updateSidebarCheckboxStatus:function(e){var s=this;t(".bssm-sidebar .name[data-id]",s.bsModal.$modal).each(function(){var i=t(this),n=i.parent().find(".bf-checkbox-multi-state"),a=n.data("current-state");t.inArray(i.data("id"),s.options.inactivateTypes)>-1?"none"!==a&&n.trigger("click",[e]):"active"!==a&&n.trigger("click",[e])})},_clearSearchResults:function(){return},_filterItems:function(t){return this.$allItems.filter(t)},handleEvent:function(t,e){var s=Array.prototype.slice.call(arguments,1);return"function"==typeof this.options.events[t]?this.options.events[t].apply(this,s):e},eventExists:function(t){return"function"==typeof this.options.events[t]},$:function(e){if(e.dataset.itemId){var s=e.dataset.itemId;return s in this.$itemsCache||(this.$itemsCache[e.dataset.itemId]=t(e,this.$modal)),this.$itemsCache[e.dataset.itemId]}return t(e,this.$modal)},selectItem:function(e){return e in this.$itemsCache||(this.$itemsCache[e]=t('.bssm-item[data-item-id="'+e+'"]',this.bsModal.$modal)),this.$itemsCache[e]},_showHide:function(t,e){for(var s=e?"show_item":"hide_item",i=0;i<t.length;i++)t[i]&&this.handleEvent(s,t[i])},get_attr:function(t,e){return t.dataset?t.dataset[e]:this.$(t,this.bsModal.$modal).attr(e)},_prepareObjectForMustache:function(t){var e=[];for(var s in t)e.push({key:s,value:t[s]});return e},_cacheItems:function(e){this.$itemsCache={};for(var s,i,n=0;n<e.length;n++)s=t(e[n]),i=s.data("item-id"),this.$itemsCache[i]=s},_length:function(t){if(!t)return 0;if(Object.keys)return Object.keys(t).length;var e,s=0;for(e in t)t.hasOwnProperty(e)&&s++;return s}},t.bs_selector_modal=function(t,s){return new e(t,s)}}(jQuery);